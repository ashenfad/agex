# Routy

Find geospatial routes and generate interactive map visualizations from natural language. Demonstrates how `agex` can work with complex, specialized libraries like `osmnx` and `folium`.

Prefer a notebook? See: [Routy (Notebook)](routy.ipynb)

## Setup

```python
from agex import Agent, Versioned, connect_llm, MemberSpec
import osmnx as ox
import folium

routy = Agent(
    name="routy",
    primer="You assist the user finding routes (OSMnx) and visualizing them (Folium).",
)

# Expose specific, high-level functions to guide the agent
routy.module(
    ox,
    visibility="low",
    recursive=True,
    configure={
        "geocoder.geocode": MemberSpec(visibility="high"),
        "graph.graph_from_point": MemberSpec(visibility="high"),
        "routing.shortest_path": MemberSpec(visibility="high"),
    },
)
routy.module(
    folium,
    visibility="low",
    recursive=True,
    configure={
        "Map": MemberSpec(visibility="high"),
        "Marker": MemberSpec(visibility="high"),
        "PolyLine": MemberSpec(visibility="high"),
    },
)
```

## Define the task (agent implements it)

```python
@routy.task
def route(prompt: str) -> folium.Map:  # type: ignore[return-value]
    "Find a route given the prompt and return a Folium map."
    pass
```

## Find a route and visualize it

```python
# The agent uses osmnx to find the route and folium to draw the map
map = route("I'd like to drive from Albany, OR to Corvallis, OR")
map.save("examples/routy-a.html")

# The agent remembers context for follow-up questions
map_alt = route("Hwy 20 is closed between Albany and Corvallis, find another way.")
map_alt.save("examples/routy-b.html")
```

See the generated maps:
- [Albany to Corvallis (Normal Route)](https://github.com/ashenfad/agex/blob/main/examples/routy-a.html)
- [Albany to Corvallis (Detour)](https://github.com/ashenfad/agex/blob/main/examples/routy-b.html)

## Why this is different

- **Direct Library Integration**: No need to write a "tool" wrapper for `osmnx` or `folium`. The agent uses the libraries directly through the registration system.
- **Complex Object Return**: The agent returns a real `folium.Map` object, not a JSON description. You can immediately save it, modify it, or embed it in a web page.
- **Dynamic Problem Solving**: The agent doesn't just call single functions. For the follow-up question, it dynamically generates its own internal helper function to temporarily remove the closed highway from the map data before finding the best path:

```python
# Helper generated by the agent to find a route while avoiding a highway
def compute_route_avoiding(G_in, orig, dest, avoid_patterns_upper):
    H = G_in.copy()
    to_remove = []
    for u, v, k, data in H.edges(keys=True, data=True):
        ref = str(data.get('ref', '') or '')
        name = str(data.get('name', '') or '')
        tags = (ref + ' ' + name).upper()
        if any(p in tags for p in avoid_patterns_upper):
            to_remove.append((u, v, k))
    if to_remove:
        H.remove_edges_from(to_remove)
    route = osmnx.routing.shortest_path(H, orig=orig, dest=dest, weight='length')
    return H, route, len(to_remove)
```

This is the core of the "code-as-action" philosophy. Instead of being confined to pre-defined tools, the agent is **stitching together** a novel solution using the building blocks you provide.

â€”

Source: https://github.com/ashenfad/agex/blob/main/examples/routy.py

